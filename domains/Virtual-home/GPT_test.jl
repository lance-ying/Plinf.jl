item_set=Dict("cutleryfork"=>4,"cutleryknife"=>4,"waterglass"=>4,"wineglass"=>4,"plate"=>4,"bowl"=>4,"wine"=>1,"cheese"=>1,"cupcake"=>4,"juice"=>1,"cucumber"=>1,"onion"=>1,"tomato"=>1,"carrot"=>1,"potato"=>1,"chicken"=>1,"salmon"=>1)
item_taken=[
Dict("cutleryfork"=>0,"cutleryknife"=>0,"waterglass"=>0,"wineglass"=>1,"plate"=>0,"bowl"=>0,"wine"=>1,"cheese"=>0,"cupcake"=>0,"juice"=>0,"cucumber"=>0,"onion"=>0,"tomato"=>0,"carrot"=>0,"potato"=>0,"chicken"=>0,"salmon"=>0),
Dict("cutleryfork"=>0,"cutleryknife"=>0,"waterglass"=>0,"wineglass"=>0,"plate"=>2,"bowl"=>0,"wine"=>0,"cheese"=>0,"cupcake"=>0,"juice"=>0,"cucumber"=>0,"onion"=>0,"tomato"=>0,"carrot"=>0,"potato"=>0,"chicken"=>0,"salmon"=>0),
Dict("cutleryfork"=>0,"cutleryknife"=>0,"waterglass"=>0,"wineglass"=>0,"plate"=>3,"bowl"=>0,"wine"=>0,"cheese"=>0,"cupcake"=>0,"juice"=>0,"cucumber"=>0,"onion"=>0,"tomato"=>0,"carrot"=>0,"potato"=>0,"chicken"=>0,"salmon"=>0),
Dict("cutleryfork"=>0,"cutleryknife"=>0,"waterglass"=>0,"wineglass"=>0,"plate"=>2,"bowl"=>2,"wine"=>0,"cheese"=>0,"cupcake"=>0,"juice"=>0,"cucumber"=>0,"onion"=>0,"tomato"=>0,"carrot"=>0,"potato"=>0,"chicken"=>0,"salmon"=>0),
Dict("cutleryfork"=>0,"cutleryknife"=>0,"waterglass"=>0,"wineglass"=>0,"plate"=>0,"bowl"=>0,"wine"=>1,"cheese"=>0,"cupcake"=>0,"juice"=>0,"cucumber"=>0,"onion"=>0,"tomato"=>0,"carrot"=>0,"potato"=>1,"chicken"=>0,"salmon"=>0),
#5
Dict("cutleryfork"=>0,"cutleryknife"=>0,"waterglass"=>0,"wineglass"=>0,"plate"=>0,"bowl"=>0,"wine"=>0,"cheese"=>0,"cupcake"=>0,"juice"=>1,"cucumber"=>0,"onion"=>0,"tomato"=>0,"carrot"=>0,"potato"=>0,"chicken"=>0,"salmon"=>0),
Dict("cutleryfork"=>2,"cutleryknife"=>0,"waterglass"=>0,"wineglass"=>0,"plate"=>2,"bowl"=>0,"wine"=>0,"cheese"=>0,"cupcake"=>0,"juice"=>0,"cucumber"=>0,"onion"=>0,"tomato"=>0,"carrot"=>0,"potato"=>0,"chicken"=>0,"salmon"=>0),
Dict("cutleryfork"=>0,"cutleryknife"=>0,"waterglass"=>0,"wineglass"=>0,"plate"=>0,"bowl"=>0,"wine"=>0,"cheese"=>0,"cupcake"=>0,"juice"=>0,"cucumber"=>0,"onion"=>0,"tomato"=>0,"carrot"=>0,"potato"=>0,"chicken"=>0,"salmon"=>0),
Dict("cutleryfork"=>0,"cutleryknife"=>0,"waterglass"=>0,"wineglass"=>0,"plate"=>0,"bowl"=>0,"wine"=>0,"cheese"=>0,"cupcake"=>0,"juice"=>0,"cucumber"=>0,"onion"=>0,"tomato"=>0,"carrot"=>0,"potato"=>0,"chicken"=>0,"salmon"=>0),
Dict("cutleryfork"=>0,"cutleryknife"=>0,"waterglass"=>0,"wineglass"=>0,"plate"=>1,"bowl"=>0,"wine"=>1,"cheese"=>1,"cupcake"=>0,"juice"=>0,"cucumber"=>0,"onion"=>0,"tomato"=>0,"carrot"=>0,"potato"=>0,"chicken"=>0,"salmon"=>0),
#10
Dict("cutleryfork"=>0,"cutleryknife"=>0,"waterglass"=>0,"wineglass"=>0,"plate"=>0,"bowl"=>0,"wine"=>0,"cheese"=>0,"cupcake"=>0,"juice"=>0,"cucumber"=>0,"onion"=>0,"tomato"=>0,"carrot"=>0,"potato"=>0,"chicken"=>0,"salmon"=>0),
Dict("cutleryfork"=>3,"cutleryknife"=>0,"waterglass"=>0,"wineglass"=>0,"plate"=>0,"bowl"=>0,"wine"=>0,"cheese"=>0,"cupcake"=>0,"juice"=>0,"cucumber"=>0,"onion"=>0,"tomato"=>0,"carrot"=>0,"potato"=>0,"chicken"=>0,"salmon"=>0),
Dict("cutleryfork"=>3,"cutleryknife"=>3,"waterglass"=>0,"wineglass"=>0,"plate"=>0,"bowl"=>0,"wine"=>0,"cheese"=>0,"cupcake"=>0,"juice"=>0,"cucumber"=>0,"onion"=>0,"tomato"=>0,"carrot"=>0,"potato"=>0,"chicken"=>0,"salmon"=>0),
Dict("cutleryfork"=>4,"cutleryknife"=>1,"waterglass"=>0,"wineglass"=>0,"plate"=>0,"bowl"=>0,"wine"=>0,"cheese"=>0,"cupcake"=>0,"juice"=>0,"cucumber"=>0,"onion"=>0,"tomato"=>0,"carrot"=>0,"potato"=>0,"chicken"=>0,"salmon"=>0),
Dict("cutleryfork"=>0,"cutleryknife"=>0,"waterglass"=>0,"wineglass"=>0,"plate"=>0,"bowl"=>0,"wine"=>0,"cheese"=>0,"cupcake"=>0,"juice"=>0,"cucumber"=>1,"onion"=>1,"tomato"=>1,"carrot"=>0,"potato"=>0,"chicken"=>0,"salmon"=>0),
#15
Dict("cutleryfork"=>0,"cutleryknife"=>0,"waterglass"=>0,"wineglass"=>0,"plate"=>0,"bowl"=>0,"wine"=>0,"cheese"=>0,"cupcake"=>0,"juice"=>0,"cucumber"=>1,"onion"=>0,"tomato"=>0,"carrot"=>0,"potato"=>0,"chicken"=>1,"salmon"=>0),
Dict("cutleryfork"=>0,"cutleryknife"=>0,"waterglass"=>0,"wineglass"=>0,"plate"=>0,"bowl"=>0,"wine"=>0,"cheese"=>0,"cupcake"=>0,"juice"=>0,"cucumber"=>0,"onion"=>0,"tomato"=>0,"carrot"=>0,"potato"=>0,"chicken"=>0,"salmon"=>0),
Dict("cutleryfork"=>0,"cutleryknife"=>0,"waterglass"=>0,"wineglass"=>0,"plate"=>0,"bowl"=>0,"wine"=>0,"cheese"=>0,"cupcake"=>0,"juice"=>0,"cucumber"=>0,"onion"=>0,"tomato"=>0,"carrot"=>0,"potato"=>0,"chicken"=>0,"salmon"=>0),
Dict("cutleryfork"=>0,"cutleryknife"=>0,"waterglass"=>0,"wineglass"=>3,"plate"=>0,"bowl"=>0,"wine"=>0,"cheese"=>0,"cupcake"=>0,"juice"=>0,"cucumber"=>0,"onion"=>0,"tomato"=>0,"carrot"=>0,"potato"=>0,"chicken"=>0,"salmon"=>0),
Dict("cutleryfork"=>0,"cutleryknife"=>0,"waterglass"=>1,"wineglass"=>0,"plate"=>0,"bowl"=>0,"wine"=>0,"cheese"=>0,"cupcake"=>0,"juice"=>1,"cucumber"=>0,"onion"=>0,"tomato"=>0,"carrot"=>0,"potato"=>0,"chicken"=>0,"salmon"=>0),

]

using IterTools
# subsets(s::AbstractSet, k) = IterTools.subsets(collect(s), k)

possible_goalsets=[["cutleryfork","cutleryknife","plate"],["cutleryfork","cutleryknife","plate","bowl"],["wine","wineglass"],["wine","wineglass","cutleryfork","cheese","plate"],["juice","waterglass"],["juice","waterglass","cutleryfork","cupcake"],
["onion","chicken","cucumber","chefknife"],["onion","tomato","cucumber","chefknife"],["onion","carrot","cucumber","chefknife"],["potato","carrot","onion","wine"],["salmon","carrot","onion","wine"],["chicken","carrot","onion","wine"]]

salient_items=[]
append!(salient_items,collect(subsets(collect(keys(item_set)), Val(1))))
append!(salient_items,collect(subsets(collect(keys(item_set)), Val(2))))
append!(salient_items,collect(subsets(collect(keys(item_set)), Val(3))))

function check_pair(pair)
    for set in possible_goalsets
        flag = true
        for item in pair
            if !(item in set)
                flag = false
                continue
            end
        end
        if flag
            return true
        end
    end
    return false
end

function extract_goals(id)
    goalset=[]
    for pair in salient_items
        if check_pair(pair)
            # goal=""
            if any(x->item_set[x]>1, pair)
                for i in 1:4
                    goal_pred = []
                    if any(x->item_taken[id][x]>i, pair)
                        continue
                    end
                    if (i==1 & length(pair)==1)
                        push!(goalset,"(on $(pair[1])1 table1)")
                        continue
                    end
                    for item in pair
                        if item_set[item]>1
                            for j in item_taken[id][item]+1:i
                                push!(goal_pred,"(on $(item)$j table1)")
                            end
                        else
                            push!(goal_pred, "(on $(item)1 table1)")
                        end
                    end
                    if length(goal_pred)>1
                        goal = "(and "
                        for p in goal_pred
                            goal = goal* p
                        end
                        goal = goal* ")"
                        push!(goalset,goal)
                    end
                    if length(goal_pred)==1
                        goal = goal_pred[1]
                        push!(goalset,goal)
                    end

                end
            else
                if length(pair)==1
                    if item_taken[id][pair[1]]!=1
                        push!(goalset,"(on $(pair[1])1 table1)")
                    end
                else
                    goal = "(and "
                    for item in pair
                        goal = goal* "(on $(item)1 table1)"
                    end
                    goal = goal* ")"
                    push!(goalset,goal)
                end
            end
        
        end
    end
    return goalset

end


function extract_goals_has(id)
    goalset=[]
    for pair in salient_items
        if check_pair(pair)
            # goal=""
            if any(x->item_set[x]>1, pair)
                for i in 1:4
                    goal_pred = []
                    if any(x->item_taken[id][x]>i, pair)
                        continue
                    end
                    if (i==1 & length(pair)==1)
                        push!(goalset,"(has robot $(pair[1])1)")
                        continue
                    end
                    for item in pair
                        if item_set[item]>1
                            for j in item_taken[id][item]+1:i
                                push!(goal_pred,"(has robot $(item)$j)")
                            end
                        else
                            push!(goal_pred, "(has robot $(item)1)")
                        end
                    end
                    if length(goal_pred)>1
                        goal = "(and "
                        for p in goal_pred
                            goal = goal* p
                        end
                        goal = goal* ")"
                        push!(goalset,goal)
                    end
                    if length(goal_pred)==1
                        goal = goal_pred[1]
                        push!(goalset,goal)
                    end
    
                    
                end
            else
                if length(pair)==1
                    if item_taken[id][pair[1]]!=1
                        push!(goalset,"(has robot $(pair[1])1)")
                    end
                else
                    goal = "(and "
                    for item in pair
                        goal = goal* "(has robot $(item)1)"
                    end
                    goal = goal* ")"
                    push!(goalset,goal)
                end
            end
        
        end
    end
    return goalset

end



utterance_examples_has = """
A human and robot are collaborating in kitchen.
Your task is to translate possible subgoals for robot to natural-language commands so the human can assign the subgoal to the robot.

Input: (has robot cupcake1)
Output: Can you get a cupcake?
Input: (and (has robot cheese1)(has robot wineglass1)(has robot wineglass2))
Output: Can you find cheese and 2 glasses?
Input: (and (has robot plate1)(has robot plate2)(has robot plate3))
Output: Can you bring 3 plates?
Input: (and (has robot plate1)(has robot plate2)(has robot cutleryfork1)(has robot cutleryfork2))
Output: Can you bring 2 plates and forks?
Input: (and (has robot onion1)(has robot tomato1))
Output: Can you get the vegetables?
Input: (and (has robot cutleryfork1) (has robot cutleryfork2) (has robot cutleryknife1) (has robot cutleryknife2))
Output: Can you bring the cutlery?


"""


utterance_examples = """
A human and robot are collaborating in kitchen.
Your task is to translate possible subgoals for robot to natural-language commands so the human can assign the subgoal to the robot.

Input: (on cupcake1 table1)
Output: Can you get a cupcake?
Input: (and (on cheese1 table1)(on wineglass1 table1)(on wineglass2 table1))
Output: Can you find cheese and 2 glasses?
Input: (and (on plate1 table1)(on plate2 table1)(on plate3 table1))
Output: Can you bring 3 plates?
Input: (and (on plate1 table1)(on plate2 table1)(on cutleryfork1 table1)(on cutleryfork2 table1))
Output: Can you bring 2 plates and forks?
Input: (and (on onion1 fridge1)(on tomato1 table1))
Output: Can you get the vegetables?
Input: (and (on cutleryfork1 table1) (on cutleryfork2 table1) (on cutleryknife1 table1) (on cutleryknife2 table1))
Output: Can you bring the cutlery?


"""

using Gen, GenGPT3

gpt3 = GPT3GenerativeFunction(model = "text-davinci-003", max_tokens=64)

goal_prob_total = Dict()


for scenario_id in 1:20

    utterance = utterance_dict_literal[scenario_id]
    goal_prob = []
    for g in extract_goals_has(scenario_id)
        prompt = utterance_examples_has * "Input: $g"
        prompt *= "\n Output:"
        trace, weight = generate(gpt3, (prompt,), choicemap(:output => utterance))
        push!(goal_prob, weight)

    end
    goal_prob_total[scenario_id]=goal_prob
    print(scenario_id)
    sleep(5)
    # push!(goal_prob_total, )
end


# The weight will be log P(completion | prompt) = log P("Olympus Mons." | "What is the tallest mountain on Mars?")
println(weight)

ENV["OPENAI_API_KEY"] = "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"
# utt ~ gpt3(prompt)

using HDF5, JLD

save("/Users/lance/Documents/GitHub/Plinf.jl/domains/Virtual-home/data.jld", "prob", goal_prob_total)
save("/Users/lance/Documents/GitHub/Plinf.jl/domains/Virtual-home/data.jld", "top5", goal_top5)

goal_top5 = Dict()
action_literal = Dict()
for scenario_id in collect(keys(utterance_dict_literal))
    
    idxs = partialsortperm(goal_prob_total[scenario_id], 1:5, rev=true)
    ids = argmax(goal_prob_total[scenario_id])
    action_literal[scenario_id]=extract_goals_has(scenario_id)[ids]
end

g = "(and (has robot cutleryfork1)(has robot cutleryfork2)(has robot cutleryfork3)(has robot waterglass1)(has robot waterglass2)(has robot waterglass3))"
prompt = utterance_examples_has * "Input: $g"
prompt *= "\n Output:"
trace, weight = generate(gpt3, (prompt,), choicemap(:output => "Can you find 3 forks and some glasses?"))

weight

weight